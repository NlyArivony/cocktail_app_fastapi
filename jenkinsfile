pipeline {
    agent any

    stages {
        stage('Checkout') {
            steps {
                checkout([$class: 'GitSCM', branches: [[name: '*/cicd']], userRemoteConfigs: [[url: 'https://github.com/NlyArivony/cocktail_app_fastapi.git']]])
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    def customImageTag = "my-python-app:${env.BUILD_NUMBER}"
                    docker.build(customImageTag, ".")
                }
            }
        }

        stage('Run Tests') {
            steps {
                script {
                    def customImageTag = "my-python-app:${env.BUILD_NUMBER}"
                    def containerName = "my-container-${env.BUILD_NUMBER}" // Use a unique container name

                    def containerId = docker.image(customImageTag).run("--name ${containerName} -d")

                    // You may wait here if your application requires initialization time
                    // sleep time: 30, unit: 'SECONDS'

                    // Run pytest inside the container
                    sh "docker exec ${containerName} pytest"

                    // Stop and remove the container
                    sh "docker stop ${containerName}"
                    sh "docker rm ${containerName}"
                }
            }
        }
    }
}
